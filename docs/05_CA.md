# Laboratorio Active Directory: Seguridad y PowerShell

Configuración de una Autoridad de Certificación (CA) para firmar scripts de PowerShell y permitir su ejecución segura mediante GPO.

---

## 1. Instalación de la CA

1. En **DC1**, agregar el rol **Active Directory Certificate Services**.  
2. En el asistente de configuración:  
   - Tipo de CA: **Enterprise CA**  
   - Tipo de raíz: **Root CA**  
   - Algoritmo: **RSA 2048 bits**  
   - Nombre: **Nombre_Empresa-CA**  
   - Validez: **5 años**

---

## 2. Creación de la plantilla de certificado

1. Abrir **Certificate Templates** (`certtmpl.msc`).  
2. Duplicar la plantilla **Code Signing**.  
3. Configurar:
   - Nombre: **PowerShell Code Signing**  
   - Validez: **5 años**  
   - En la pestaña **Security**, agregar el grupo **Administradores de dominio** con permisos de **Enroll** y **Read**.  
4. Desde la consola de **Certification Authority**, crear una nueva plantilla basada en “PowerShell Code Signing”.

---

## 3. Solicitud de certificado de firma

1. En `certmgr.msc` → **Personal → Certificates**, ir a:  
   `All Tasks → Request New Certificate`.  
2. Seleccionar la plantilla **PowerShell Code Signing** y completarla.  

[Ver captura del certificado](../images/ca.png)
	
---

## 4. Configuración de GPO para ejecución de scripts

1. Editar la GPO **Seguridad**.  
2. Ir a:  
   `Computer Configuration → Policies → Administrative Templates → Windows Components → Windows PowerShell`.  
3. Habilitar la directiva **Turn on Script Execution**.

---

## 5. Firma digital de scripts PowerShell

1. Obtener el certificado por huella digital y firmar el script:

   **powershell**
   
   $cert = Get-ChildItem -Path Cert:\CurrentUser\My | Where-Object Thumbprint -eq "d42e578e6e3a40f73ecc21f192f814e9ee43b0e9"
   Set-AuthenticodeSignature -FilePath "C:\Scripts\Script.ps1" -Certificate $cert
   
[Ver captura del certificado firmado](../images/script.png)
   
2. Verificar que el script firmado (Script.ps1) se ejecuta correctamente desde el equipo Windows 11.

   **Powershell**
   
   Powershell.exe -ExecutionPolicy Bypass -NoProfile -File Script.ps1 

[Ver captura del script en Windows 11](../images/ca.png)
